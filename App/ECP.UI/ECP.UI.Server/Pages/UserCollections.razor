@page "/collections"
@rendermode InteractiveAuto
@using ECP.UI.Server.Services
@using ECP.UI.Server.Components.Artworks
@inject IUserCollectionsService CollectionsService
@inject ISnackbar Snackbar
@inherits UserCollectionsBase

<div class="collections-page">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-6">
     
        <div class="page-header mb-8">
            <MudText Typo="Typo.h3" Align="Align.Center" Class="mb-2" Style="font-weight: 300; color: var(--mud-palette-text-primary);">
                Your Collections
            </MudText>
            <MudText Typo="Typo.body1" Align="Align.Center" Style="color: var(--mud-palette-text-secondary);">
                Organize and explore your curated artwork collections
            </MudText>
        </div>

        @if (_userCollections?.Any() == true)
        {
            <MudGrid Spacing="3" Class="collections-grid">
                @foreach (Collection item in _userCollections)
                {
                    <MudItem xs="6" sm="4" md="3" lg="2"  style="padding: 8px;  height: 15rem;">
                        <a href="/collection/@item.Id" class="d-flex align-center mud-width-full" style="height: 100%; background-color: white;">
                            <MudPaper Class="d-flex flex-column" Elevation="2" Style="height: 100%; width: 100%; justify-content: space-between; position: relative;">
                                <div class="collection-preview">
                                    @if (item.Artworks?.Any() == true)
                                    {
                                        <div class="preview-image-container">
                                            <MudImage ObjectFit="ObjectFit.Cover" Src="@item.Artworks.FirstOrDefault()?.Thumbnail?.Url" Style="height: 100%; width: 100%;"></MudImage> 
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="empty-collection-placeholder">
                                            <MudIcon Icon="@Icons.Material.Filled.Collections"  
                                                                                Style="font-size: 3rem; color: var(--mud-palette-text-disabled);" />
                                        </div>
                                    }
                                </div>

                                <div class="collection-data">
                                    <div class="collection-info">
                                    <MudText Typo="Typo.subtitle1" Class="collection-name">
                                        @item.Name
                                    </MudText>
                                    <MudText Typo="Typo.caption" Class="collection-count">
                                        @item.Artworks.Count @(item.Artworks.Count == 1 ? "artwork" : "artworks")
                                    </MudText>
                                    </div>
                                </div>
               
                            </MudPaper>
                        </a>
                        <div class="collection-actions" style="position: relative; float: right; top: -100%; right: 0; width: 1.5rem; margin: 1rem;">
                            <MudIconButton OnClick="() => HandleDelete(item.Id)" Class="ma-0 pa-0" Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" />
                        </div>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <div class="empty-state">
                <MudPaper Class="pa-8 text-center" Style="background: transparent;" Elevation="0">
                    <MudIcon Icon="@Icons.Material.Filled.Collections"  
                                            Style="font-size: 4rem; color: var(--mud-palette-text-disabled); margin-bottom: 16px;" />
                    <MudText Typo="Typo.h6" Class="mb-2" Style="color: var(--mud-palette-text-secondary);">
                        No Collections Yet
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-disabled); max-width: 400px; margin: 0 auto;">
                        Start building your personal art collection by saving artworks you discover and love.
                    </MudText>
                    <MudButton Variant="Variant.Filled"  
                                               Color="Color.Primary"  
                                               StartIcon="@Icons.Material.Filled.Add"
                                               Class="mt-4"
                                               Href="/explore">
                        Explore Artworks
                    </MudButton>
                </MudPaper>
            </div>
        }
    </MudContainer>
</div>

<style>
    .mud-icon-root{
        fill: white !important;
        transition: fill 0.3s ease-out;
    }

    .mud-icon-button:hover .mud-icon-root {
        fill: #ff441f !important;
    }
</style>

@code {
    protected async override Task OnInitializedAsync()
    {
        await FetchCollections();
        StateHasChanged();
    }


    private async Task HandleDelete(string collectionID)
    {
        
        var deleteResult = await CollectionsService.DeleteCollectionAsync(collectionID);
        if (!deleteResult.IsSuccess)
        {
            Snackbar.Add("Ops! There was a problem on our end. Please try again.");
        }
        else
        {
            int index = _userCollections.FindIndex(c => c.Id == collectionID);
            _userCollections.RemoveAt(index);
            StateHasChanged();
        }
        
    }
}
